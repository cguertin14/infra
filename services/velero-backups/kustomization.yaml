apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: velero-backups

resources:
- resources/namespace.yml

generators:
- secrets-generator.yml

images:
- name: velero/velero-plugin-for-aws
  newTag: v1.12.0

helmCharts:
- name: velero
  releaseName: velero
  namespace: velero-backups
  repo: https://vmware-tanzu.github.io/helm-charts
  version: 8.7.2
  includeCRDs: true
  valuesInline:
    credentials:
      existingSecret: velero-s3-credentials
    
    initContainers:
    - name: velero-plugin-for-aws
      image: velero/velero-plugin-for-aws
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins

    deployNodeAgent: true
    configuration:
      defaultRepoMaintainFrequency: 12h
      defaultSnapshotMoveData: true
      features: EnableCSI
      uploaderType: kopia
      backupStorageLocation:
      - name: aws
        default: true
        provider: aws
        bucket: velero-backups-bucket20250418195129140400000001
        accessMode: ReadWrite
        config:
          region: us-east-1
      volumeSnapshotLocation:
      - name: aws
        provider: aws
        default: true
        config:
          region: us-east-1

    schedules:
      etcd-backups:
        disabled: false
        schedule: "0 2 * * *" # every day at 2AM
        useOwnerReferencesInBackup: false
        paused: false
        skipImmediately: false
        template:
          ttl: "336h" # 2 weeks / 14 days
          storageLocation: aws
          # Most namespaces
          includedNamespaces:
          - argo-rollouts
          - argocd
          - blog
          - cert-manager
          - cloudnative-pg
          - educs
          - gpu-operator
          - home-assistant
          - immich
          - kube-node-lease
          - kube-public
          - kube-system
          - mediaplatform
          - metallb-system
          - mongodb-operator
          - monitoring
          - pihole
          - rook-ceph
          - synology-nfs
          - synology-nfs-media
          # PVs & PVCs are backed up in separate backup schedules
          excludedClusterScopedResources:
          - persistentVolumes
          excludedNamespaceScopedResources:
          - persistentVolumeClaims
      persistent-data-backups:
        disabled: false
        schedule: "30 2 * * *" # every day at 2:30AM
        useOwnerReferencesInBackup: false
        paused: false
        skipImmediately: false
        template:
          ttl: "336h" # 2 weeks / 14 days
          storageLocation: aws
          snapshotMoveData: true
          includedClusterScopedResources:
          - persistentVolumes
          # Do not back up PVCs here, only PVs - as they are backed up in the etcd-backups schedule.
          includedNamespaceScopedResources:
          - persistentVolumeClaims
